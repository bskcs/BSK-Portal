<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BSK Envelope Printing System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background-color: #dfeeff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #003366;
      margin-top: 0;
    }

    .banner {
      background-color: #007bff;
      color: white;
      padding: 0 10px;
      font-weight: bold;
      font-size: 16px;
      position: relative;
      overflow: hidden;
      height: 30px;
      line-height: 30px;
      white-space: nowrap;
      margin-bottom: 15px;
    }

    .scrolling-text {
      position: absolute;
      white-space: nowrap;
      animation: scroll-left 30s linear infinite;
      top: 0;
      height: 30px;
      line-height: 30px;
    }

    @keyframes scroll-left {
      from { left: 100%; }
      to { left: -100%; }
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .controls button {
      padding: 10px 20px;
      margin: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      border-radius: 5px;
    }
	
     .controls button:hover {
       background-color: #28a745; /* Green on hover */
     }

      .controls button {
       transition: background-color 0.3s ease;
      }

    .controls input[type="file"] {
      margin-right: 10px;
    }

    /* Search input container for positioning clear button */
    .search-container {
      position: relative;
      display: inline-block;
    }

    /* Search input with space for clear button */
    #searchInput {
      padding: 8px;
      font-size: 16px;
      width: 250px;
      border-radius: 5px;
      border: 1px solid #000;
      margin-top: 10px;
      padding-right: 25px; /* extra space for clear button */
      box-sizing: border-box;
    }

    /* Custom clear (Ã—) button styles */
    #clearSearch {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      display: none;
      line-height: 1;
      padding: 0;
      color: #999;
    }

    /* Commenting out to allow custom clear button to work */
    /*
    #searchInput::-ms-clear {
      display: none;
    }
    #searchInput::-webkit-search-cancel-button {
      display: none;
    }
    */

    table {
      width: 95%;
      margin: auto;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #ccc;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    .highlight {
      background-color: yellow;
    }

    .nameCell {
      transition: background-color 0.3s ease;
    }

    /* Print Page size fixed */
    @page {
      size: 9in 4in;
      margin: 0;
    }

    /* Print Area Styling */
    #envelopesContainer {
      display: none;
      padding: 0;
    }

    .envelope {
      width: 9in;
      height: 4in;
      margin: 0;
      padding: 0.3in 0.5in;
      box-sizing: border-box;
      background-color: #fff;
      page-break-after: always;
      position: relative;
      font-size: 12px;
      color: #000;
      overflow: hidden;
    }

    .logo {
      position: absolute;
      top: 0.5in;
      left: 0.5in;
      width: 80px;
    }

    .to {
      position: absolute;
      top: 1in;
      left: 4in;
      font-size: 14px;
      line-height: 1.5;
      width: 4.5in;
    }

    .to strong {
      font-weight: bold;
    }

    .from {
      position: absolute;
      bottom: 0.4in;
      left: 0.5in;
      font-size: 12px;
      line-height: 1.2;
    }

    .return-reason {
      position: absolute;
      bottom: 0.4in;
      right: 0.5in;
      font-size: 10px;
      line-height: 1.2;
    }

    .return-reason label {
      display: block;
      margin-bottom: 0.2em;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      .print-area, .print-area * {
        visibility: visible;
      }
      .print-area {
        position: absolute;
        top: 0;
        left: 0;
        width: 9in;
        height: 4in;
      }
      button, input[type="file"], h1, table, #searchInput {
        display: none !important;
      }
      input[type="checkbox"] {
        -webkit-appearance: checkbox;
        appearance: checkbox;
        display: inline-block !important;
        width: 12px;
        height: 12px;
        margin-right: 5px;
        border: 1px solid #000;
      }
    }
  </style>
</head>
<body>

  <h1>BSKCS Envelope Printing System</h1>

  <div class="banner">
    <div class="scrolling-text">Welcome to BSKCS Envelope Printing System â€“ Fast & Reliable Envelope Print Solutions</div>
  </div>

  <div class="controls">
    <input type="file" id="excelFile" accept=".xlsx,.xls" />
    <button onclick="loadExcel()">Load Excel</button>
    <button onclick="generate()">Generate Selected Envelopes</button>
    <button onclick="clearSelection()">Clear Selection</button>
    <button onclick="window.print()">Print / Save PDF</button>
    <br />
    
    <div class="search-container">
      <input type="search" id="searchInput" placeholder="ðŸ” Search by Name..." />
      <button id="clearSearch" title="Clear Search">Ã—</button>
    </div>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Select</th>
        <th>Memno</th>
        <th>Name</th>
        <th>Father/Husband Name</th>
        <th>Copies</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="envelopesContainer" class="print-area"></div>

  <script>
    let globalRows = [];

    function loadExcel() {
      const fileInput = document.getElementById("excelFile");
      const tableBody = document.getElementById("tableBody");
      const file = fileInput.files[0];

      if (!file) return alert("Please choose an Excel file.");

      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        tableBody.innerHTML = "";
        globalRows = [];

        let sNo = 1;
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const memno = row[0]?.toString().trim();
          const name = row[1]?.toString().trim();
          const relation = row[2]?.toString().trim();
          const addrPhone = row[3]?.toString().trim() || "";

          // Skip rows that look like headers or empty
          if (!memno && !name && !relation) continue;
          if (memno === "Memno" && name === "Member Name") continue;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${sNo}</td>
            <td><input type="checkbox" class="selectRow" /></td>
            <td>${memno || ""}</td>
            <td class="nameCell">${name || ""}</td>
            <td>${relation || ""}</td>
            <td><input type="number" value="1" class="copiesInput" min="1" style="width:60px" /></td>
          `;
          tableBody.appendChild(tr);

          globalRows.push({ memno, name, relation, addrPhone });
          sNo++;
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function filterByName() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#tableBody tr");

      rows.forEach((row) => {
        const nameCell = row.querySelector(".nameCell");
        const memnoCell = row.cells[2];
        const nameText = nameCell.textContent.toLowerCase();
        const memnoText = memnoCell.textContent.toLowerCase();

        if (filter && (nameText.includes(filter) || memnoText.includes(filter))) {
          nameCell.classList.add("highlight");
          row.style.display = "";
        } else if (!filter) {
          nameCell.classList.remove("highlight");
          row.style.display = "";
        } else {
          nameCell.classList.remove("highlight");
          row.style.display = "none";
        }
      });
    }

    function generate() {
      const envelopesContainer = document.getElementById("envelopesContainer");
      envelopesContainer.innerHTML = "";

      const rows = document.querySelectorAll("#tableBody tr");
      let hasSelected = false;

      rows.forEach((row, i) => {
        const checkbox = row.querySelector("input.selectRow");
        const copiesInput = row.querySelector("input.copiesInput");
        const copies = copiesInput ? parseInt(copiesInput.value) : 1;

        if (checkbox && checkbox.checked && copies > 0) {
          hasSelected = true;

          const memno = row.cells[2].textContent.trim();
          const name = row.cells[3].textContent.trim();
          const relation = row.cells[4].textContent.trim();
          const addrPhone = globalRows[i].addrPhone || "";

          const address = addrPhone.split(/Ph[.:ï¼š]/)[0].trim();
          const phoneMatch = addrPhone.match(/Ph[.:ï¼š]*\s*(.*)/i);
          let phone = "";

          if (phoneMatch) {
            phone = phoneMatch[1]
              .split(",")
              .map(p => p.trim())
              .filter(p => p && !["NA", "N/A", "N.A", "N.A.", ".", ":"].includes(p.toUpperCase()))
              .filter((val, idx, self) => self.indexOf(val) === idx)
              .join(", ");
          }

          for (let c = 0; c < copies; c++) {
            const div = document.createElement("div");
            div.className = "envelope";
            div.innerHTML = `
              <img src="logo.png" class="logo" />
              <div class="to">
                <strong>To:</strong><br>
                ${name}${relation ? ", S/o " + relation : ""}<br>
                ${address}${phone ? `<br><strong>Phone:</strong> ${phone}` : ""}
              </div>
              <div class="from">
                <strong>If Undelivered Please Return to:</strong><br>
                Baba Sai Kripa Co-operative (U) T/C Society Ltd.<br>
                D-41/A, Gali No.9, West Vinod Nagar Delhi-110092<br>
                Phone: 01169655241
              </div>
              <div class="return-reason">
                <strong>Reason of return:</strong><br>
                <label><input type="checkbox"> Door Locked</label>
                <label><input type="checkbox"> No Such Person</label>
                <label><input type="checkbox"> Denied</label>
                <label><input type="checkbox"> Left Without Information</label>
              </div>
            `;
            envelopesContainer.appendChild(div);
          }
        }
      });

      if (!hasSelected) {
        alert("Please select at least one row to generate envelopes.");
        return;
      }

      envelopesContainer.style.display = "block";
      envelopesContainer.scrollIntoView({ behavior: "smooth" });
    }

    function clearSelection() {
      const rows = document.querySelectorAll("#tableBody tr");
      rows.forEach(row => {
        const checkbox = row.querySelector("input.selectRow");
        const copiesInput = row.querySelector("input.copiesInput");
        if (checkbox) checkbox.checked = false;
        if (copiesInput) copiesInput.value = 1;
      });
    }

    // Search input event listeners for filtering & clear button
    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearSearch');

    searchInput.addEventListener('input', () => {
      clearBtn.style.display = searchInput.value ? 'block' : 'none';
      filterByName();
    });

    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      clearBtn.style.display = 'none';
      filterByName();
      searchInput.focus();
    });

    searchInput.addEventListener('search', function() {
      if (!this.value) {
        clearBtn.style.display = 'none';
        filterByName();
      }
    });
  </script>
</body>
</html>
